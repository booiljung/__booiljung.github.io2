<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://booiljung.github.io/robot/ros2_humble/chapter_21/2104/" rel="canonical"/>
<link href="../../../../img/favicon.ico" rel="shortcut icon"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<title>TF2에서의 좌표 변환 예제 - 실험 도서관</title>
<link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet"/>
<link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet"/>
<link href="../../../../css/base.css" rel="stylesheet"/>
<link href="../../../../css/highlight.css" rel="stylesheet"/>
<link href="../../../../css/custom.css" rel="stylesheet"/>
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
<script src="../../../../js/jquery-3.2.1.min.js"></script>
<script src="../../../../js/bootstrap-3.3.7.min.js"></script>
<script src="../../../../js/highlight.pack.js"></script>
<base target="_top"/>
<script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "1. \uae30\ubcf8 \uc88c\ud45c \ubcc0\ud658 \uac1c\ub150", url: "#_top", children: [
          ]},
          {title: "2. \ud68c\uc804 \ud589\ub82c\uacfc \ubcc0\uc704 \ubca1\ud130", url: "#2", children: [
          ]},
          {title: "3. ROS2\uc5d0\uc11c\uc758 TF2 \uc88c\ud45c \ubcc0\ud658 \uc608\uc81c", url: "#3-ros2-tf2", children: [
          ]},
          {title: "4. \ud2b8\ub79c\uc2a4\ud3fc \ub370\uc774\ud130\uc5d0\uc11c \ud68c\uc804 \ubc0f \ubcc0\uc704 \ucd94\ucd9c", url: "#4", children: [
              {title: "\ubcc0\ud658\uc744 \ud1b5\ud55c \uc88c\ud45c \ubcc0\ud658 \uc608\uc81c", url: "#_1" },
          ]},
          {title: "5. \uc810\uc758 \ubcc0\ud658", url: "#5", children: [
              {title: "\ucf54\ub4dc\ub85c \ud45c\ud604\ud55c \uc88c\ud45c \ubcc0\ud658", url: "#_2" },
          ]},
          {title: "6. TF2\uc5d0\uc11c\uc758 \uc88c\ud45c \ubcc0\ud658 \uccb4\uc778", url: "#6-tf2", children: [
              {title: "\ubcc0\ud658 \uccb4\uc778\uc758 \uac1c\ub150", url: "#_3" },
              {title: "\ucf54\ub4dc \uc608\uc81c", url: "#_4" },
          ]},
          {title: "7. TF2\uc5d0\uc11c \uc88c\ud45c \ubcc0\ud658 \uccb4\uc778\uc758 \uc2dc\uac01\ud654", url: "#7-tf2", children: [
              {title: "tf_monitor \uba85\ub839\uc5b4 \uc0ac\uc6a9", url: "#tf_monitor" },
              {title: "TF2 \ud2b8\ub9ac\uc758 \uc608\uc2dc", url: "#tf2" },
          ]},
          {title: "8. \ucffc\ud130\ub2c8\uc5b8\uc744 \uc774\uc6a9\ud55c \ud68c\uc804 \ucc98\ub9ac", url: "#8", children: [
              {title: "\ucffc\ud130\ub2c8\uc5b8\uc758 \uc815\uc758", url: "#_5" },
          ]},
          {title: "9. \ucffc\ud130\ub2c8\uc5b8 \ud68c\uc804 \uc608\uc81c", url: "#9", children: [
          ]},
          {title: "10. \ucffc\ud130\ub2c8\uc5b8\uc744 \uc774\uc6a9\ud55c \uc88c\ud45c \ubcc0\ud658", url: "#10", children: [
          ]},
          {title: "11. \uc88c\ud45c \ubcc0\ud658\uc758 \uc2e4\uc2dc\uac04 \ucc98\ub9ac", url: "#11", children: [
              {title: "\uc2e4\uc2dc\uac04 \uc88c\ud45c \ubcc0\ud658 \uc608\uc81c", url: "#_6" },
          ]},
        ];

    </script>
<script src="../../../../js/base.js"></script>
<script src="../../../../js/google_analytics.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-3F4LHCTF88"></script>
</meta></head>
<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>
<div class="container-fluid wm-page-content">
<a name="_top"></a>
<div aria-label="navigation" class="row wm-article-nav-buttons" role="navigation">
<div class="wm-article-nav pull-right">
<a class="btn btn-xs btn-default pull-right" href="../2105/">
        Next
        <i aria-hidden="true" class="fa fa-chevron-right"></i>
</a>
<a class="btn btn-xs btn-link" href="../2105/">
        TF2에서의 시간 동기화 처리
      </a>
</div>
<div class="wm-article-nav">
<a class="btn btn-xs btn-default pull-left" href="../2103/">
<i aria-hidden="true" class="fa fa-chevron-left"></i>
        Previous</a><a class="btn btn-xs btn-link" href="../2103/">
        좌표 변환의 기본 개념
      </a>
</div>
</div>
<h3 id="1">1. 기본 좌표 변환 개념</h3>
<p>TF2는 ROS2에서 좌표 변환을 관리하는 패키지로, 각 좌표계 간의 변환을 처리한다. 로봇 시스템에서 다양한 센서나 모터, 로봇 팔 등이 각기 다른 좌표계를 가질 수 있기 때문에 좌표계 간 변환은 필수적이다. 변환은 주로 회전 행렬과 변위 벡터로 이루어지며, 이를 통해 로봇의 위치나 방향을 다른 좌표계로 변환할 수 있다.</p>
<p>좌표 변환은 주로 4x4 변환 행렬을 사용하여 이루어지며, 이를 통해 회전과 변위를 한 번에 표현할 수 있다. 변환 행렬은 다음과 같이 구성된다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{T} =
\begin{bmatrix}
\mathbf{R} &amp; \mathbf{t} \\
0 &amp; 1
\end{bmatrix}
</div>
<script type="math/tex; mode=display">
\mathbf{T} =
\begin{bmatrix}
\mathbf{R} & \mathbf{t} \\
0 & 1
\end{bmatrix}
</script>
</div>
<p>여기서:
- <span class="arithmatex"><span class="MathJax_Preview">\mathbf{T}</span><script type="math/tex">\mathbf{T}</script></span>는 4x4 변환 행렬
- <span class="arithmatex"><span class="MathJax_Preview">\mathbf{R}</span><script type="math/tex">\mathbf{R}</script></span>은 3x3 회전 행렬
- <span class="arithmatex"><span class="MathJax_Preview">\mathbf{t}</span><script type="math/tex">\mathbf{t}</script></span>는 3x1 변위 벡터 (평행 이동)
- 아래의 <span class="arithmatex"><span class="MathJax_Preview">0</span><script type="math/tex">0</script></span>과 <span class="arithmatex"><span class="MathJax_Preview">1</span><script type="math/tex">1</script></span>은 행렬의 크기를 맞추기 위한 값이다.</p>
<h3 id="2">2. 회전 행렬과 변위 벡터</h3>
<p>회전 행렬 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{R}</span><script type="math/tex">\mathbf{R}</script></span>는 로봇이 회전하는 방향을 나타내며, 변위 벡터 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{t}</span><script type="math/tex">\mathbf{t}</script></span>는 좌표계를 평행 이동시키는 역할을 한다. 3차원 공간에서의 회전은 주로 Euler 각이나 회전 행렬, 쿼터니언으로 표현된다.</p>
<p>3차원 회전 행렬 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{R}</span><script type="math/tex">\mathbf{R}</script></span>는 다음과 같이 나타낼 수 있다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{R} =
\begin{bmatrix}
r_{11} &amp; r_{12} &amp; r_{13} \\
r_{21} &amp; r_{22} &amp; r_{23} \\
r_{31} &amp; r_{32} &amp; r_{33}
\end{bmatrix}
</div>
<script type="math/tex; mode=display">
\mathbf{R} =
\begin{bmatrix}
r_{11} & r_{12} & r_{13} \\
r_{21} & r_{22} & r_{23} \\
r_{31} & r_{32} & r_{33}
\end{bmatrix}
</script>
</div>
<p>변위 벡터 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{t}</span><script type="math/tex">\mathbf{t}</script></span>는 다음과 같이 나타낼 수 있다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{t} =
\begin{bmatrix}
t_x \\
t_y \\
t_z
\end{bmatrix}
</div>
<script type="math/tex; mode=display">
\mathbf{t} =
\begin{bmatrix}
t_x \\
t_y \\
t_z
\end{bmatrix}
</script>
</div>
<p>따라서, 변환 행렬 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{T}</span><script type="math/tex">\mathbf{T}</script></span>는 회전과 평행 이동을 통합하여 다음과 같이 나타낼 수 있다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{T} =
\begin{bmatrix}
r_{11} &amp; r_{12} &amp; r_{13} &amp; t_x \\
r_{21} &amp; r_{22} &amp; r_{23} &amp; t_y \\
r_{31} &amp; r_{32} &amp; r_{33} &amp; t_z \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
</div>
<script type="math/tex; mode=display">
\mathbf{T} =
\begin{bmatrix}
r_{11} & r_{12} & r_{13} & t_x \\
r_{21} & r_{22} & r_{23} & t_y \\
r_{31} & r_{32} & r_{33} & t_z \\
0 & 0 & 0 & 1
\end{bmatrix}
</script>
</div>
<p>이 행렬을 사용하면 좌표계 A에서의 한 점 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{p}_A = (x_A, y_A, z_A)</span><script type="math/tex">\mathbf{p}_A = (x_A, y_A, z_A)</script></span>를 좌표계 B로 변환할 수 있다. 변환된 좌표계 B에서의 점 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{p}_B</span><script type="math/tex">\mathbf{p}_B</script></span>는 다음과 같이 계산된다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\begin{bmatrix}
x_B \\
y_B \\
z_B \\
1
\end{bmatrix}
=
\mathbf{T}
\begin{bmatrix}
x_A \\
y_A \\
z_A \\
1
\end{bmatrix}
</div>
<script type="math/tex; mode=display">
\begin{bmatrix}
x_B \\
y_B \\
z_B \\
1
\end{bmatrix}
=
\mathbf{T}
\begin{bmatrix}
x_A \\
y_A \\
z_A \\
1
\end{bmatrix}
</script>
</div>
<p>이를 풀어서 쓰면 다음과 같다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\begin{aligned}
x_B &amp;= r_{11}x_A + r_{12}y_A + r_{13}z_A + t_x \\
y_B &amp;= r_{21}x_A + r_{22}y_A + r_{23}z_A + t_y \\
z_B &amp;= r_{31}x_A + r_{32}y_A + r_{33}z_A + t_z
\end{aligned}
</div>
<script type="math/tex; mode=display">
\begin{aligned}
x_B &= r_{11}x_A + r_{12}y_A + r_{13}z_A + t_x \\
y_B &= r_{21}x_A + r_{22}y_A + r_{23}z_A + t_y \\
z_B &= r_{31}x_A + r_{32}y_A + r_{33}z_A + t_z
\end{aligned}
</script>
</div>
<p>이 수식은 좌표계 A에서의 점을 좌표계 B로 변환할 때 사용하는 기본적인 변환 공식이다. </p>
<h3 id="3-ros2-tf2">3. ROS2에서의 TF2 좌표 변환 예제</h3>
<p>ROS2에서 TF2를 사용해 두 좌표계 간 변환을 수행하는 예제를 살펴보겠다. TF2에서는 두 좌표계 간의 관계를 트랜스폼(Transform)으로 정의하며, 이는 시간에 따라 변할 수 있는 동적 정보를 포함한다.</p>
<p>먼저, Python을 사용하여 TF2 변환을 구현하는 기본적인 방법은 다음과 같다.</p>
<pre><code class="language-python">import tf2_ros
import geometry_msgs.msg

# TF2 버퍼와 리스너 초기화
tf_buffer = tf2_ros.Buffer()
tf_listener = tf2_ros.TransformListener(tf_buffer)

# 변환을 시도할 좌표계 설정
source_frame = 'base_link'
target_frame = 'camera_link'

# 현재 시간을 기준으로 변환 요청
try:
    trans = tf_buffer.lookup_transform(target_frame, source_frame, rospy.Time(0))
    print("Transform: ", trans)
except (tf2_ros.LookupException, tf2_ros.ConnectivityException, tf2_ros.ExtrapolationException):
    print("Transform not available.")
</code></pre>
<p>이 코드는 두 좌표계 'base_link'와 'camera_link' 간의 변환을 요청하는 예제이다. TF2는 시간에 따라 동적으로 변할 수 있는 트랜스폼을 처리하기 때문에, 변환을 요청할 때 시간을 명시할 수 있다. 여기서는 현재 시점의 트랜스폼을 요청하고 있다.</p>
<p>이후의 변환 과정을 위해 트랜스폼의 자세한 내용을 살펴보면, 트랜스폼은 변위와 회전 정보를 포함한다. ROS2에서는 이 트랜스폼 데이터를 활용하여 좌표계 간의 변환을 처리한다.</p>
<h3 id="4">4. 트랜스폼 데이터에서 회전 및 변위 추출</h3>
<p>위의 예제에서 <code>lookup_transform</code> 함수를 통해 얻은 트랜스폼 객체에는 좌표계 간의 변위와 회전 정보가 포함되어 있다. 이 정보를 활용하여 좌표 변환을 수행할 수 있다.</p>
<p>트랜스폼 객체는 다음과 같은 형식으로 변위와 회전 데이터를 포함한다.</p>
<pre><code class="language-python">trans.transform.translation.x
trans.transform.translation.y
trans.transform.translation.z

trans.transform.rotation.x
trans.transform.rotation.y
trans.transform.rotation.z
trans.transform.rotation.w
</code></pre>
<p>이 데이터 중 변위는 <code>translation</code>에 저장되며, 회전 정보는 쿼터니언 형태로 <code>rotation</code>에 저장된다. 쿼터니언은 회전을 나타내는 방식 중 하나로, 기울기(roll), 피치(pitch), 요(roll)를 회전 행렬보다 효율적으로 계산할 수 있다.</p>
<h4 id="_1">변환을 통한 좌표 변환 예제</h4>
<p>트랜스폼 객체에서 변위와 회전 정보를 추출한 후, 이를 이용하여 좌표를 변환하는 방법을 예제로 보여드리겠다. 예를 들어, 좌표계 A에서의 한 점 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{p}_A = (x_A, y_A, z_A)</span><script type="math/tex">\mathbf{p}_A = (x_A, y_A, z_A)</script></span>를 좌표계 B로 변환하려면 다음과 같은 절차를 따른다.</p>
<ol>
<li>변위 벡터 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{t}</span><script type="math/tex">\mathbf{t}</script></span> 추출:</li>
</ol>
<pre><code class="language-python">t_x = trans.transform.translation.x
t_y = trans.transform.translation.y
t_z = trans.transform.translation.z
</code></pre>
<p>이를 통해 변위 벡터 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{t} = (t_x, t_y, t_z)</span><script type="math/tex">\mathbf{t} = (t_x, t_y, t_z)</script></span>를 추출할 수 있다.</p>
<ol>
<li>쿼터니언을 회전 행렬로 변환:</li>
</ol>
<p>쿼터니언을 회전 행렬로 변환하려면 추가적인 라이브러리나 수식을 사용할 수 있다. 여기서는 <code>tf_transformations</code> 라이브러리를 사용하여 쿼터니언을 회전 행렬로 변환하는 방법을 보여드린다.</p>
<pre><code class="language-python">import tf_transformations

# 쿼터니언 값 추출
q_x = trans.transform.rotation.x
q_y = trans.transform.rotation.y
q_z = trans.transform.rotation.z
q_w = trans.transform.rotation.w

# 쿼터니언을 회전 행렬로 변환
rotation_matrix = tf_transformations.quaternion_matrix([q_x, q_y, q_z, q_w])
</code></pre>
<p>이때 변환된 회전 행렬은 4x4 행렬 형태로 반환되며, 이는 앞서 설명한 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{R}</span><script type="math/tex">\mathbf{R}</script></span>을 포함한다.</p>
<h3 id="5">5. 점의 변환</h3>
<p>이제 좌표계 A에서의 점 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{p}_A = (x_A, y_A, z_A)</span><script type="math/tex">\mathbf{p}_A = (x_A, y_A, z_A)</script></span>를 좌표계 B로 변환하기 위해 변위 벡터와 회전 행렬을 사용하여 다음과 같은 수식을 적용한다.</p>
<p>우선, 점 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{p}_A</span><script type="math/tex">\mathbf{p}_A</script></span>를 동차 좌표계로 표현한 후, 변환 행렬을 적용한다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{p}_A =
\begin{bmatrix}
x_A \\
y_A \\
z_A \\
1
\end{bmatrix}
</div>
<script type="math/tex; mode=display">
\mathbf{p}_A =
\begin{bmatrix}
x_A \\
y_A \\
z_A \\
1
\end{bmatrix}
</script>
</div>
<p>변환된 좌표계 B에서의 점 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{p}_B</span><script type="math/tex">\mathbf{p}_B</script></span>는 다음과 같이 계산된다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{p}_B = \mathbf{T} \cdot \mathbf{p}_A
</div>
<script type="math/tex; mode=display">
\mathbf{p}_B = \mathbf{T} \cdot \mathbf{p}_A
</script>
</div>
<p>변환 행렬 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{T}</span><script type="math/tex">\mathbf{T}</script></span>는 회전 행렬 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{R}</span><script type="math/tex">\mathbf{R}</script></span>과 변위 벡터 <span class="arithmatex"><span class="MathJax_Preview">\mathbf{t}</span><script type="math/tex">\mathbf{t}</script></span>로 이루어져 있으며, 앞서 설명한 4x4 변환 행렬 형식을 사용한다.</p>
<h4 id="_2">코드로 표현한 좌표 변환</h4>
<p>Python 코드로 이를 구현하면 다음과 같다.</p>
<pre><code class="language-python">import numpy as np

# 변위 벡터 및 회전 행렬
translation = np.array([t_x, t_y, t_z])
rotation_matrix = rotation_matrix[:3, :3]  # 3x3 회전 행렬 추출

# 좌표계 A에서의 점
point_A = np.array([x_A, y_A, z_A])

# 좌표계 B로 변환
point_B = np.dot(rotation_matrix, point_A) + translation
</code></pre>
<p>위 코드는 좌표계 A에서 좌표계 B로 변환하는 과정을 보여준다. 회전 행렬과 변위 벡터를 사용하여 좌표 변환을 수행하고, 결과적으로 변환된 좌표계를 계산한다.</p>
<h3 id="6-tf2">6. TF2에서의 좌표 변환 체인</h3>
<p>좌표 변환은 단일 좌표계 간의 변환뿐만 아니라 여러 좌표계를 거치는 복잡한 변환도 필요할 수 있다. 예를 들어, 로봇 시스템에서 로봇 베이스(<code>base_link</code>)에서 카메라(<code>camera_link</code>), 그리고 센서 좌표계(<code>sensor_link</code>)까지 변환이 필요할 수 있다. 이런 경우 TF2는 변환 체인을 자동으로 처리하여, 중간 좌표계를 거쳐 최종 변환을 수행한다.</p>
<h4 id="_3">변환 체인의 개념</h4>
<p>여러 좌표계를 변환하는 경우, 변환 체인은 각 좌표계 간의 관계를 연결한 트리 구조를 형성한다. 예를 들어, 다음과 같은 변환 체인을 가정할 수 있다:</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{T}_{\text{camera\_link}}^{\text{base\_link}} \rightarrow \mathbf{T}_{\text{sensor\_link}}^{\text{camera\_link}} 
</div>
<script type="math/tex; mode=display">
\mathbf{T}_{\text{camera\_link}}^{\text{base\_link}} \rightarrow \mathbf{T}_{\text{sensor\_link}}^{\text{camera\_link}} 
</script>
</div>
<p>이 경우, 로봇의 베이스 좌표계에서 카메라 좌표계를 거쳐 센서 좌표계까지 변환하는 과정을 하나의 체인으로 처리할 수 있다. 이 변환은 TF2의 <code>lookup_transform</code> 기능을 사용하여 자동으로 처리된다.</p>
<h4 id="_4">코드 예제</h4>
<p>다음은 ROS2에서 변환 체인을 처리하는 예제이다.</p>
<pre><code class="language-python"># 여러 좌표계를 거쳐 변환 요청
try:
    # base_link에서 sensor_link까지의 변환 체인
    trans = tf_buffer.lookup_transform('sensor_link', 'base_link', rospy.Time(0))
    print("Transform Chain: ", trans)
except (tf2_ros.LookupException, tf2_ros.ConnectivityException, tf2_ros.ExtrapolationException):
    print("Transform chain not available.")
</code></pre>
<p>이 코드는 <code>base_link</code>에서 <code>sensor_link</code>까지의 변환을 요청하며, TF2는 중간 좌표계(<code>camera_link</code>)를 자동으로 처리한다. 중간 변환들을 수동으로 계산할 필요 없이, TF2가 알아서 중간 변환을 연결하여 최종 변환을 수행한다.</p>
<h3 id="7-tf2">7. TF2에서 좌표 변환 체인의 시각화</h3>
<p>복잡한 변환 체인은 TF2에서 트리 구조로 표현되며, 각 좌표계 간의 관계를 시각화할 수 있다. 이를 위해 <code>rqt_tf_tree</code> 또는 <code>tf_monitor</code> 명령어를 사용할 수 있다.</p>
<h4 id="tf_monitor">tf_monitor 명령어 사용</h4>
<pre><code class="language-bash">ros2 run tf2_tools view_frames
</code></pre>
<p>이 명령을 실행하면 TF2의 좌표 변환 트리를 시각화한 PDF 파일을 생성할 수 있다. 이를 통해 각 좌표계 간의 변환 관계를 쉽게 파악할 수 있다.</p>
<h4 id="tf2">TF2 트리의 예시</h4>
<p>다이어그램을 활용하여 간단한 좌표 변환 체인을 시각화하면 다음과 같다:</p>
<div class="mermaid">graph LR
    A[base_link] --&gt; B[camera_link]
    B --&gt; C[sensor_link]
</div>
<p>이 구조는 로봇의 베이스 좌표계에서 카메라, 그리고 센서 좌표계까지의 변환 체인을 간단히 나타낸다.</p>
<h3 id="8">8. 쿼터니언을 이용한 회전 처리</h3>
<p>앞서 설명한 좌표 변환에서 회전은 중요한 요소 중 하나이며, 회전을 표현하는 방법에는 여러 가지가 있다. 대표적인 방법은 <strong>Euler 각</strong>과 <strong>쿼터니언</strong>이다. TF2에서는 주로 쿼터니언을 사용하여 회전을 표현한다. 쿼터니언은 특이점(singularity)이 발생하지 않으며, 연속적인 회전을 효율적으로 계산할 수 있는 장점이 있다.</p>
<h4 id="_5">쿼터니언의 정의</h4>
<p>쿼터니언은 다음과 같이 4개의 요소로 정의된다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{q} = \left( q_x, q_y, q_z, q_w \right)
</div>
<script type="math/tex; mode=display">
\mathbf{q} = \left( q_x, q_y, q_z, q_w \right)
</script>
</div>
<p>여기서:
- <span class="arithmatex"><span class="MathJax_Preview">q_x, q_y, q_z</span><script type="math/tex">q_x, q_y, q_z</script></span>는 회전축을 나타내는 벡터의 성분이며,
- <span class="arithmatex"><span class="MathJax_Preview">q_w</span><script type="math/tex">q_w</script></span>는 회전각의 코사인 값과 관련된 요소이다.</p>
<p>쿼터니언은 다음과 같은 수식을 통해 회전 행렬로 변환할 수 있다.</p>
<div class="arithmatex">
<div class="MathJax_Preview">
\mathbf{R} =
\begin{bmatrix}
1 - 2(q_y^2 + q_z^2) &amp; 2(q_x q_y - q_z q_w) &amp; 2(q_x q_z + q_y q_w) \\
2(q_x q_y + q_z q_w) &amp; 1 - 2(q_x^2 + q_z^2) &amp; 2(q_y q_z - q_x q_w) \\
2(q_x q_z - q_y q_w) &amp; 2(q_y q_z + q_x q_w) &amp; 1 - 2(q_x^2 + q_y^2)
\end{bmatrix}
</div>
<script type="math/tex; mode=display">
\mathbf{R} =
\begin{bmatrix}
1 - 2(q_y^2 + q_z^2) & 2(q_x q_y - q_z q_w) & 2(q_x q_z + q_y q_w) \\
2(q_x q_y + q_z q_w) & 1 - 2(q_x^2 + q_z^2) & 2(q_y q_z - q_x q_w) \\
2(q_x q_z - q_y q_w) & 2(q_y q_z + q_x q_w) & 1 - 2(q_x^2 + q_y^2)
\end{bmatrix}
</script>
</div>
<p>이 회전 행렬을 이용하여 쿼터니언으로부터 3D 공간에서의 회전을 계산할 수 있다.</p>
<h3 id="9">9. 쿼터니언 회전 예제</h3>
<p>ROS2의 TF2 패키지에서는 쿼터니언을 쉽게 사용할 수 있다. 앞서 언급한 Python 코드 예제를 확장하여 쿼터니언 회전을 적용해보겠다.</p>
<pre><code class="language-python">import tf_transformations

# 쿼터니언 값 추출
q_x = trans.transform.rotation.x
q_y = trans.transform.rotation.y
q_z = trans.transform.rotation.z
q_w = trans.transform.rotation.w

# 쿼터니언을 회전 행렬로 변환
rotation_matrix = tf_transformations.quaternion_matrix([q_x, q_y, q_z, q_w])

# 회전 행렬 출력
print("Rotation Matrix: \n", rotation_matrix)
</code></pre>
<p>위 코드에서 쿼터니언을 이용해 회전 행렬을 계산하고, 이를 이용해 좌표계 간의 변환을 처리할 수 있다. </p>
<h3 id="10">10. 쿼터니언을 이용한 좌표 변환</h3>
<p>쿼터니언을 이용한 좌표 변환은 변환 행렬을 사용하는 것과 동일한 원리로 진행된다. 쿼터니언을 회전 행렬로 변환한 후, 변위 벡터와 함께 사용하여 좌표 변환을 처리한다. 예를 들어, 좌표계 A에서 좌표계 B로의 변환을 수행할 때, 쿼터니언으로부터 얻은 회전 행렬과 변위 벡터를 사용하여 변환된 좌표를 계산할 수 있다.</p>
<pre><code class="language-python">import numpy as np

# 변위 벡터 및 회전 행렬
translation = np.array([t_x, t_y, t_z])
rotation_matrix = rotation_matrix[:3, :3]  # 3x3 회전 행렬 추출

# 좌표계 A에서의 점
point_A = np.array([x_A, y_A, z_A])

# 좌표계 B로 변환
point_B = np.dot(rotation_matrix, point_A) + translation
print("Transformed Point in B: ", point_B)
</code></pre>
<h3 id="11">11. 좌표 변환의 실시간 처리</h3>
<p>ROS2의 TF2는 좌표 변환을 실시간으로 처리할 수 있다. 특히 로봇의 움직임이나 센서 데이터가 시간에 따라 변화할 때, 실시간으로 좌표계를 변환하여 처리하는 것이 중요하다. TF2는 이와 같은 실시간 변환을 효율적으로 지원하며, 노드 간 통신을 통해 동적으로 좌표 변환 정보를 업데이트할 수 있다.</p>
<p>실시간 변환 처리를 위해서는 TF2의 <code>lookup_transform</code> 메소드를 반복적으로 호출하여 변환 정보를 갱신하고, 최신 좌표계를 기반으로 변환을 수행해야 한다. 예를 들어, 로봇이 이동하면서 좌표계가 지속적으로 변하는 상황에서는 변환 정보를 실시간으로 반영하여 로봇의 위치나 방향을 추적할 수 있다.</p>
<h4 id="_6">실시간 좌표 변환 예제</h4>
<p>다음은 실시간으로 좌표 변환을 처리하는 예제이다.</p>
<pre><code class="language-python">import rospy
import tf2_ros
import geometry_msgs.msg

def get_transform():
    tf_buffer = tf2_ros.Buffer()
    tf_listener = tf2_ros.TransformListener(tf_buffer)

    while not rospy.is_shutdown():
        try:
            # 실시간으로 좌표 변환 요청
            trans = tf_buffer.lookup_transform('sensor_link', 'base_link', rospy.Time(0))
            print("Real-time Transform: ", trans)
        except (tf2_ros.LookupException, tf2_ros.ConnectivityException, tf2_ros.ExtrapolationException):
            rospy.logwarn("Transform not available")

        rospy.sleep(0.1)  # 100ms 간격으로 변환 요청

if __name__ == '__main__':
    rospy.init_node('real_time_tf_listener')
    get_transform()
</code></pre>
<p>위 코드는 매 100ms마다 변환 정보를 요청하여 실시간으로 좌표 변환을 처리한다. 이를 통해 로봇의 움직임이나 센서 데이터의 변화를 추적할 수 있다.</p>
<br/>
<div aria-label="navigation" class="row wm-article-nav-buttons" role="navigation">
<div class="wm-article-nav pull-right">
<a class="btn btn-xs btn-default pull-right" href="../2105/">
        Next
        <i aria-hidden="true" class="fa fa-chevron-right"></i>
</a>
<a class="btn btn-xs btn-link" href="../2105/">
        TF2에서의 시간 동기화 처리
      </a>
</div>
<div class="wm-article-nav">
<a class="btn btn-xs btn-default pull-left" href="../2103/">
<i aria-hidden="true" class="fa fa-chevron-left"></i>
        Previous</a><a class="btn btn-xs btn-link" href="../2103/">
        좌표 변환의 기본 개념
      </a>
</div>
</div>
<br/>
</div>
<footer class="container-fluid wm-page-content">
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>